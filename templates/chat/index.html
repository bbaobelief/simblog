{% extends "layout/base.html" %}
{% block title %} 博客 {% endblock %}
{% block content %}
        {% load staticfiles %}
        <div class="content">
            <div class="header-clear"></div>
            <div id="result_message" class="one-half-responsive"></div>
            
            <div class="decoration hide-if-responsive"></div>
            <div class="one-half-responsive last-column">
                <div class="container no-bottom">
                    <div class="contact-form no-bottom"> 
                        <form method="post" class="contactForm" id="contactForm">
                            <fieldset>
                              <div class="formFieldWrap">
                                  <label class="field-title contactNameField" for="contactNameField">Name:<span>(required)</span></label>
                                  <input type="text" name="contactNameField" value="Anonymous" class="contactField requiredField" id="text_username"/>
                              </div>
                              <div class="formTextareaWrap">
                                  <label class="field-title contactMessageTextarea" for="contactMessageTextarea">Message: <span>(required)</span></label>
                                  <textarea name="contactMessageTextarea" class="contactTextarea requiredField" id="text_message"></textarea>
                              </div>
                              <div class="formSubmitButtonErrorsWrap">
                                  <input type="button" class="buttonWrap button button-green contactSubmitButton" id="send_message" value="SEND" />
                              </div>
                            </fieldset>
                        </form>       
                    </div>
                </div>
            </div>
            <div class="decoration"></div> 
        </div>
        {% include 'layout/footer.html' %}
<script src="{{ STATIC_URL }}js/ws4redis.js" type="text/javascript"></script>    
<script type="text/javascript">
jQuery(document).ready(function($) {
  var classObj=
    {
      ToUnicode:function(str) 
      {
        return escape(str).replace(/%/g,"\\").toLowerCase();
      },
      UnUnicode:function(str)
      {
        return unescape(str.replace(/\\/g, "%"));
      }
    }
  // 获取用户输入转换json对象为字符串发送
  function getResult()
  {
    username = classObj.ToUnicode($('#text_username').val()); 
    message = classObj.ToUnicode($('#text_message').val()); 
    var obj= {'username':username,'message':message};
		return JSON.stringify(obj);
  }
    
	var ws4redis = WS4Redis({
		uri: '{{ WEBSOCKET_URI }}public?subscribe-broadcast&publish-broadcast&echo',
		receive_message: receiveMessage,
		heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
	});
  
	// send message though the Websocket to the server
	$("#text_message").keydown(function(event) {
		if (event.keyCode === 13) {
			event.preventDefault();
      ws4redis.send_message(getResult());
		}
	});
  //清空输入框
	$("#text_message").click(function() {
    $('#text_message').val("");
	});  
  
	$('#send_message').click(function() {
		ws4redis.send_message(getResult());
	});

	// receive a message though the Websocket from the server
	function receiveMessage(msg) {
    var result_message = $('#result_message');
    var resmsg = JSON.parse(msg);
    
    //如果输入内容和接收到的内容相等，则认为是自己发送的数据
		if ( msg === getResult() ) {
      username = classObj.UnUnicode(resmsg.username); 
      message = classObj.UnUnicode(resmsg.message); 
			result_message.append('<em class="speach-right-title">'+username+':</em>'+'<p class="speach-right blue-bubble">'+message+'</p>'+'<div class="clear"></div>');
    } 
    else {
      username = classObj.UnUnicode(resmsg.username); 
      message = classObj.UnUnicode(resmsg.message); 
      result_message.append('<em class="speach-left-title">'+username+':</em>'+'<p class="speach-left">'+message+'</p>'+'<div class="clear"></div>');
    }
	}
});
</script>
{% endblock %}